---
title: "COVID-19 Belém-PA"
output: 
  flexdashboard::flex_dashboard:
    navbar:
      - { icon: "fa-twitter", href: "https://twitter.com/CoronavirusBra1?s=20&t=aF-tOgKsLox9VkpEEGeNiA", 
      align: right}
      - { icon: "fa-facebook",  
      href: "https://sesma.belem.pa.gov.br", align: right}
      - { icon: "fa-instagram", 
      href: "https://www.instagram.com/sesma.pmb/", align: right}
    theme: "yeti"
    orientation: rows
    vertical_layout: scroll
    runtime: shiny
    css: style.css
---
 
```{r setup, include=FALSE, context = "server"}

pacman::p_load(tidyverse, rio, janitor, RColorBrewer, knitr, 
       rmarkdown, ggrepel, plotly, forecast, ggridges, 
       reshape2, R0, shiny, flexdashboard, shinydashboard, av, magick,
       ggridges, hrbrthemes, gapminder, gganimate, png, gifski, xts, dygraphs)

knitr::opts_chunk$set(echo = FALSE)
```

```{r}
banco_1 <- read.csv2("casos_positivos-20220825112418265479.csv", 
                     encoding = "UTF-8", sep = ",")

banco_1 <- banco_1 |> 
  janitor::clean_names() |> 
  as_tibble()

monitoramento <- banco_1 |> 
  dplyr::filter(municipio_residencia == "Belém") |> 
  dplyr::mutate(datanot = as.Date(data_notificacao, format = "%d/%m/%Y"),
         dataobt = as.Date(data_obito, format = "%d/%m/%Y"),
         data_IS = as.Date(data_inicio_sintomas, format = "%d/%m/%Y"),
         CPF = as.character(cpf),  # Deixa o CPF como character mesmo, confia 
         nome = str_to_upper(nome),
         id = as.character(id),
         Faixa_Etaria = case_when(idade <= 10~"0 a 10 anos",
                                  idade <= 20~"11 a 20 anos",
                                  idade <= 30~"21 a 30 anos",
                                  idade <= 40~"31 a 40 anos",
                                  idade <= 50~"41 a 50 anos",
                                  idade <= 60~"51 a 60 anos",
                                  idade <= 70~"61 a 70 anos",
                                  idade <= 80~"71 a 80 anos",
                                  idade <= 90~"81 a 90 anos",
                                  idade >  90~"Acima de 90 anos"),
         month = format(datanot, "%m"),
         year = format(datanot, "%Y"),
         Mes = recode(month, "01" = "Janeiro", 
                      "02" = "Fevereiro",
                      "03" = "Março", 
                      "04" = "Abril", 
                      "05" = "Maio", 
                      "06" = "Junho",
                      "07" = "Julho", 
                      "08" = "Agosto",
                      "09" = "Setembro", 
                      "10" = "Outubro",
                      "11" = "Novembro", 
                      "12" = "Dezembro"),
         Mes = factor(Mes, levels = c("Janeiro", "Fevereiro", "Março", "Abril",
                                      "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"))) |> 
  drop_na(datanot) |> 
  arrange(datanot)

dados <- monitoramento |>
  filter(municipio_residencia == "Belém") |>  
  group_by(datanot) |> 
  summarise(count = n()) |> 
  mutate(acumulado = cumsum(count),
         log = log(count)) |> 
  mutate(ano = format(datanot, "%Y"))
###
df1 <- monitoramento |> 
  dplyr::filter(datanot >= "2022-01-01") |> 
            dplyr::select(datanot) |> 
            dplyr::group_by(datanot) |> 
            summarise(count = n()) |>  
            rename(date = datanot,
                   confirmed = count)

# ------------Preencher datas
datas <- data.frame(date = seq.POSIXt(as.POSIXct("2022-01-01"), as.POSIXct(max(df1$date)), 
                    by = "days")) 

df <- full_join(df1, datas, by = "date") |> 
  mutate(confirmed = ifelse(is.na(confirmed), 0, confirmed),
         date = as.Date(date, format = "%d/%m/%Y"),
         log_casos = log(confirmed)) |> 
  arrange(date)

# ---------------------------
        gt <-generation.time("weibull", c(3.4, 2))
        
        curva <- abs(df$confirmed)

        rt = est.R0.TD(epi = curva,
                  gt,
                  begin=1,
                  end=(as.numeric(length(curva))-1),
                  correct=T,
                  nsim=1000)
        
        names(curva)=df1$date
        
        df2=as.data.frame(cbind(rt$R,rt$conf.int))
        df2$date=seq.Date(from=as.Date(rt$begin,
                                       origin = "2022-01-01"),
                          length.out = rt$end.nb,by="days",)
        names(df2)=c("rt","lower","upper","date")

# -----  Previsões
        dados_1_xts <- dados |> 
  dplyr::filter(datanot >= "2022-01-01") |> 
  dplyr::mutate(log_casos = log(count)) |> 
  dplyr::select(datanot, count, log_casos)

fit.xts <- auto.arima(ts(dados_1_xts$log_casos, frequency = 365))
forecast_length <- 30

fore.xts <- forecast(fit.xts, h  = forecast_length)

fore.dates <- seq.Date(from = max(dados_1_xts$datanot+1),
                       to = max(dados_1_xts$datanot+forecast_length), 
                       by = "days")

# ----- Previsões acumuladas
dados_1_xts_a <- dados |> 
  dplyr::filter(datanot >= "2022-01-01") |> 
  dplyr::select(datanot, count) |> 
  dplyr::mutate(acumulado = cumsum(count))

fit.xts_a <- auto.arima(ts(dados_1_xts_a$acumulado, frequency = 365))
forecast_length_a <- 30

fore.xts_a <- forecast(fit.xts_a, h  = forecast_length_a)

fore.dates_a <- seq.Date(from = max(dados_1_xts_a$datanot+1),
                       to = max(dados_1_xts_a$datanot+forecast_length), 
                       by = "days")

```

Casos {data-icon="fa-globe"}
=========================================

## row value boxes {data-height=140}

### Casos totais de COVID-19 {.value-box}
```{r}
flexdashboard::valueBox(
  monitoramento |> 
    group_by(datanot) |> 
    summarise(count = n()) |>
    summarise(soma = sum(count))) 
```

### Casos em 2022 {.value-box}
```{r}
flexdashboard::valueBox(
  monitoramento |> 
    filter(datanot >= "2022-01-01") |> 
    group_by(datanot) |> 
    summarise(count = n()) |>
    summarise(soma = sum(count)))
```

### Óbitos totais de COVID-19 {.value-box} 
```{r}
flexdashboard::valueBox(
  monitoramento |>
    group_by(dataobt) |>
    summarise(count = n()) |>
    summarise(soma = sum(count)))
```

### Óbitos em 2022  {.value-box} 
```{r}
flexdashboard::valueBox(
  monitoramento |>
    filter(obito == "Sim",
      dataobt>= "2022-01-01") |>
    group_by(dataobt) |>
    summarise(count = n()) |>
    summarise(soma = sum(count)))
```

### Taxa de propagação R(t) atual {.value-box} 
```{r}
flexdashboard::valueBox(
df2 |> 
    dplyr::filter(date == max(date)) |> 
    summarise(rt = rt) |> 
    as.numeric() |>
    round(digits = 2)) 
``` 

### {.value-box} 
```{r}
flexdashboard::valueBox(round(max(fore.xts_a$mean)-min(fore.xts_a$mean), 
                              digits = 2),
                          caption = "Previsão de casos para os próximos 30 dias")
```

## Pagina1 {data-height=300}

###
```{r, fig.dim=c(1,1)}

casos_totais <- monitoramento |>  
  group_by(datanot) |> 
  summarise(count = n()) 

obitos_totais <- monitoramento |> 
  filter(obito == "Sim") |> 
  group_by(dataobt) |> 
  summarise(obitos = n()) |> 
  rename(datanot = dataobt)

casos_obitos <- full_join(casos_totais, obitos_totais, by = "datanot") |> 
  rename(casos = count) |> 
  drop_na(datanot)

casos1 <- xts(casos_obitos$casos, order.by = casos_obitos$datanot)
obitos1 <- xts(casos_obitos$obitos, order.by = casos_obitos$datanot)

plot1 <- cbind(casos1, obitos1)


dygraph(plot1) |> 
  dyBarSeries('obitos1', color = "red") |> 
  dyEvent(x = "2020-12-31", "2020", labelLoc = 'top') |> 
  dyEvent(x = "2021-12-31", "2021", labelLoc = 'top') |> 
  dySeries(name = "casos1", label = "Casos") |> 
  dySeries(name = "obitos1", label = "Óbitos")

```




## row plot 1 {data-height=300}


### 
```{r, echo=FALSE,message=FALSE, fig.align='center', fig.dim=c(1,2)}

don_casos <- monitoramento |> 
  mutate(dia_mes = format(datanot, "%d/%m"),
         ano = format(datanot, "%Y")) |> 
  group_by(dia_mes, ano) |> 
  summarise(count = n()) |> 
  spread(key = ano, value = count) |> 
  mutate(datanot = as.Date(dia_mes, format = "%d/%m")) |> 
  filter(datanot >= max(`2022`)-60)


casos_2020 <- xts(don_casos$`2020`, order.by = don_casos$datanot)
casos_2021 <- xts(don_casos$`2021`, order.by = don_casos$datanot)
casos_2022 <- xts(don_casos$`2022`, order.by = don_casos$datanot)

casos <- cbind(casos_2020, casos_2021, casos_2022)

dygraph(casos) |> 
  dySeries("casos_2020", label = "Casos 2020") |> 
  dySeries("casos_2021", label = "Casos 2021") |> 
  dySeries("casos_2022", label = "Casos 2022") |> 
  dyOptions(colors = brewer.pal(3, "Set1")) |> 
  dyHighlight(highlightSeriesOpts = list(strokewidth = 3)) |> 
  dyLegend(width = 500) 

```

###
```{r, echo=FALSE,message=FALSE, fig.align='center',fig.dim=c(1,2)}
don_casos_log <- monitoramento |> 
  mutate(dia_mes = format(datanot, "%d-%m"),
         ano = format(datanot, "%Y")) |> 
  group_by(dia_mes, ano) |> 
  summarise(count = n()) |> 
  spread(key = ano, value = count)

casos_2020 <- xts(log10(don_casos$`2020`), order.by = don_casos$datanot)
casos_2021 <- xts(log10(don_casos$`2021`), order.by = don_casos$datanot)
casos_2022 <- xts(log10(don_casos$`2022`), order.by = don_casos$datanot)

casos <- cbind(casos_2020, casos_2021, casos_2022)

dygraph(casos, ylab = "Número de casos", ) |> 
  dySeries("casos_2020", label = "Casos 2020") |> 
  dySeries("casos_2021", label = "Casos 2021") |> 
  dySeries("casos_2022", label = "Casos 2022") |> 
  dyOptions(colors = brewer.pal(3, "Set1")) |> 
  dyHighlight(highlightSeriesOpts = list(strokewidth = 3)) |> 
  dyLegend(width = 500) 
```

## Row
###

```{r}
monitoramento |>
  filter(datanot >= "2022-01-01") |>
  group_by(Mes) |>
  summarise(count = n()) |>
  ggplot(aes(x = Mes, y = count, fill = Mes)) +
  geom_col(color = "Black") +
  scale_fill_brewer(palette = "Set3") +
  geom_point() +
  labs(x = "Mês", y = "Número de casos",
       title = "Casos de COVID-19 por mês") +
  geom_text(aes(label = count), vjust = -.5) +
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(face = "bold"))
```

Óbitos {data-icon="fa-table"}
========================================

## row value boxes 

### Casos COVID-19 {.value-box}
```{r}
flexdashboard::valueBox(
  monitoramento |> 
    group_by(datanot) |> 
    summarise(count = n()) |>
    summarise(soma = sum(count))) 
```

### Casos {.value-box}
```{r}
flexdashboard::valueBox(
  monitoramento |> 
    filter(datanot >= "2022-01-01") |> 
    group_by(datanot) |> 
    summarise(count = n()) |>
    summarise(soma = sum(count)))
```

### Óbitos  {.value-box} 
```{r}
flexdashboard::valueBox(
  monitoramento |>
    filter(obito == "Sim",
      dataobt>= "2022-01-01") |>
    group_by(dataobt) |>
    summarise(count = n()) |>
    summarise(soma = sum(count)))
```

### Taxa de propagação R(t) atual {.value-box} 
```{r}
flexdashboard::valueBox(
df2 |> 
    dplyr::filter(date == max(date)) |> 
    summarise(rt = rt) |> 
    as.numeric() |>
    round(digits = 2))
``` 

### {.value-box} 
```{r}

flexdashboard::valueBox(round(max(fore.xts_a$mean)-min(fore.xts_a$mean), 
                              digits = 2),
                          caption = "Previsão de casos para os próximos 30 dias")
  
```

## Óbitos
### 

```{r, echo=FALSE,message=FALSE, fig.align='center',fig.height=1}
ggplotly(
monitoramento |> 
  filter(dataobt >= "2021-01-01",
         obito == "Sim") |> 
  mutate(dia_mes = format(dataobt, "%d/%m"),
         ano = format(dataobt, "%Y")) |> 
  group_by(dia_mes, ano) |> 
  summarise(count = n()) |> 
  spread(key = ano, value = count) |> 
  mutate(dataobt = as.Date(dia_mes, format = "%d/%m")) |> 
  filter(dataobt >= max(`2022`)-60) |> 
  ggplot() +
  geom_line(aes(x = dataobt, y = `2021`, group = 1, color = "2021"), 
            lwd = .7, alpha = .7) +
  geom_line(aes(x = dataobt, y = `2022`, group = 1, color = "2022"), 
            lwd = .7, alpha = .7) +
  scale_x_date(date_breaks = "month", date_labels = "%b") +
  scale_color_manual(values = c("red", "blue")) +
  labs(x = "Data", y = "Óbitos", color = "Ano",
       title = "Número de óbitos por COVID-19 em Belém-PA") +
  theme_bw()) 
```

###
```{r, echo=FALSE,message=FALSE, fig.align='center'}
ggplotly(
monitoramento |> 
  filter(dataobt >= "2021-01-01",
         obito == "Sim") |> 
  mutate(dia_mes = format(dataobt, "%d/%m"),
         ano = format(dataobt, "%Y")) |> 
  group_by(dia_mes, ano) |> 
  summarise(count = n()) |> 
  spread(key = ano, value = count) |> 
  mutate(dataobt = as.Date(dia_mes, format = "%d/%m")) |> 
  filter(dataobt >= max(`2022`)-60) |> 
  ggplot() +
  geom_line(aes(x = dataobt, y = `2021`, group = 1, color = "2021"), 
            lwd = .7, alpha = .7) +
  geom_line(aes(x = dataobt, y = `2022`, group = 1, color = "2022"), 
            lwd = .7, alpha = .7) +
  scale_x_date(date_labels = "%b", date_breaks = "month") +
  scale_y_log10() +
  scale_color_manual(values = c("red", "blue")) +
  labs(x = "Data", y = "Óbitos (Log)", color = "Ano",
       title = "Número de óbitos por COVID-19 (Escala Logarítma)") +
  theme_bw())
```

## Média Idade
###
```{r, echo=FALSE, warning=FALSE, message=FALSE}


p <- monitoramento |>
  filter(datanot >= "2022-01-01") |>
  group_by(datanot, obito, idade) |>
  summarise(count = n()) |>
  group_by(datanot, obito) |>
  summarise(media = mean(idade)) |>
  ggplot(aes(x = datanot, y = media,
             group = obito, color = obito)) +
  geom_line(size = 1) +
  scale_color_manual(values = c("#ff704d", "#4d4dff"),
                       breaks = c("Sim", "Não")) +
  geom_point(color = "black") +
  scale_x_date(date_breaks = "month", date_labels = "%B") +
  scale_y_continuous(breaks = seq(0,100, by = 10)) +
  labs(x = "Data", y = "Média de idade") +
  theme_ipsum() +
  transition_reveal(datanot)


animate(p, width = 900, height = 400, renderer = magick_renderer())
```


##
###

```{r, echo = FALSE, message = FALSE, fig.width = 10, fig.height= 6}
monitoramento |> 
  filter(dataobt >= "2022-01-01",
         obito == "Sim") |> 
  mutate(mes_obito = as.factor(lubridate::month(dataobt))) |> 
  group_by(mes_obito) |>
  summarise(count = n()) |> 
  ggplot(aes(x = mes_obito, y = count, fill = mes_obito)) +
  geom_col(color = "Black") +
  scale_fill_brewer(palette = "Set2") +
  scale_x_discrete(labels = c("1" = "Janeiro", "2" = "Fevereiro",
                              "3" = "Março", "4" = "Abril", "5" = "Maio",
                              "6" = "Junho", "7" = "Julho", "8" = "Agosto")) +
  geom_point() +
  labs(x = "Mês", y = "Número de casos", 
       title = "Óbitos de COVID-19 por mês") +
  geom_text(aes(label = count), vjust = -.5) +
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(face = "bold"))
```

###
```{r, echo = FALSE, message=FALSE, fig.align='center'}
monitoramento |> 
  mutate(bairro = ifelse(bairro %in% "", NA, bairro)) |> 
  group_by(bairro) |> 
  summarise(count = n()) |> 
  drop_na(bairro) |> 
  top_n(10) |> 
  ggplot(aes(x = count, y = reorder(bairro, count), fill = bairro)) +
  geom_col(color = "black") +
  labs(x = "Número de casos", y = "Bairro",
       title = "Casos de COVID-19 por bairro") +
  scale_x_continuous(limits = c(0,10000)) +
  scale_fill_brewer(palette = "Set3") +
  geom_text(aes(label = count), hjust = -.5) +
  theme_bw() +
  theme(legend.position = "none")
```

Previsão {data-icon="fa-area-chart"}
=========================================

## row value boxes
### Casos COVID-19 {.value-box}
```{r}

flexdashboard::valueBox(
  monitoramento |> 
    group_by(datanot) |> 
    summarise(count = n()) |>
    summarise(soma = sum(count)))
```

### Casos {.value-box}
```{r}
flexdashboard::valueBox(
  monitoramento |> 
    filter(datanot >= "2022-01-01") |> 
    group_by(datanot) |> 
    summarise(count = n()) |>
    summarise(soma = sum(count)))
```

### Óbitos  {.value-box} 
```{r}
flexdashboard::valueBox(
  monitoramento |>
    filter(obito == "Sim",
      dataobt>= "2022-01-01") |>
    group_by(dataobt) |>
    summarise(count = n()) |>
    summarise(soma = sum(count)))
```

### {.value-box} 
```{r}
flexdashboard::valueBox(
df2 |> 
    dplyr::filter(date == max(date)) |> 
    summarise(rt = rt) |> 
    as.numeric() |>
    round(digits = 2), 
caption = "Taxa de propagação R(t) atual")
``` 

### {.value-box} 
```{r}
flexdashboard::valueBox(round(max(fore.xts_a$mean)-min(fore.xts_a$mean),
                              digits = 2),
                          caption = "Previsão de casos para os próximos 30 dias")
```

## Column
### Previsão de casos
 
```{r}
plot_ly() |> 
  add_lines(x = dados_1_xts$datanot,
            y = dados_1_xts$log_casos, 
            color = I("black"),
            name = "Observado",
            mode = "lines+markers") |> 
  add_lines(x = fore.dates, y = fore.xts$mean, color = I("blue"), 
            name = "Previsão") %>%
  add_ribbons(x = fore.dates, 
              ymin = fore.xts$lower[, 2], 
              ymax = fore.xts$upper[, 2],
              color = I("gray95"), 
              name = "Intervalo de Confiança 95%") %>%
  add_ribbons(x = fore.dates, 
              ymin = fore.xts$lower[, 1], 
              ymax = fore.xts$upper[, 1],
              color = I("gray80"), name = "Intervalo de Confiança 80%") |> 
  layout(legend = list(orientation = "h", y = 1.3, x = 0),
    xaxis = list(
        type = 'date',
        tickformat = "%d/%b",
        ticklabelmode = "month"))
```

### Casos acumulados
```{r, echo=FALSE,message=FALSE, fig.align='center'}



plot_ly() |> 
  add_lines(x = dados_1_xts_a$datanot, y = dados_1_xts_a$acumulado, 
            color = I("black"),
            name = "Observado",
            mode = 'lines+markers') |> 
  add_lines(x = fore.dates_a, y = fore.xts_a$mean, color = I("blue"), 
            name = "Previsão") %>%
  add_ribbons(x = fore.dates_a, 
              ymin = fore.xts_a$lower[, 2], 
              ymax = fore.xts_a$upper[, 2],
              color = I("gray95"), 
              name = "Intervalo de Confiança 95%") %>%
  add_ribbons(x = fore.dates_a, 
              ymin = fore.xts_a$lower[, 1], 
              ymax = fore.xts_a$upper[, 1],
              color = I("gray80"), name = "Intervalo de Confiança 80%") |> 
    layout(legend = list(orientation = "h", y = 1.3, x = 0))

```

## Column
### Prophet Plot
```{r}
pacman::p_load(prophet)

dados_p <- dados |> 
  group_by(month = lubridate::floor_date(datanot, 'month')) |> 
  summarise(soma = sum(count))

# Dados -------------------------------------------------------------------
dados_prophet <- dados_p |> 
  dplyr::select(month, soma) |> 
  rename("ds" = 'month',
         "y" = 'soma') |> 
  drop_na(ds)

dados_prophet$ds <- as.Date(dados_prophet$ds, "%Y/%m/%d")
  
# Model and predict -------------------------------------------------------
model <- prophet(dados_prophet)

# Previsões
future <- make_future_dataframe(model, periods = 12, freq = "month")
forecast <- predict(model, future)

# Plots -------------------------------------------------------------------
dyplot.prophet(model, forecast)
```

Taxa de Propagação R(t)
===

A estimativa R(t) é uma medida chave do quão rápido o vírus está se espalhando numa determinada população. 
Corresponde ao número médio de pessoas infectadas por pessoa infecciosa. Se o R(t) estiver acima de 1.0 indica que o vírus está se espalhando rapidamente na população e quando o R(t) está abaixo de 1.0, indica que o vírus está sob controle. 

Por exemplo, uma taxa de propagação de 1,54 indica que a cada 100 pessoas infectadas com o vírus conseguem transmitir a doença para outras 154 pessoas saudáveis.

Uma recomendação é de que medidas de isolamento e distanciamento sejam flexibilizadas apenas se a taxa de propag   ação R(t) estiver abaixo de 1 por pelo menos uma semana.

Vale destacar que somente a análise do R(t) não caracteriza um determinado território em relação à gravidade, deve-se levar em consideação o R(t) e o número absoluto de casos. 

## Rt
### R(t)
```{r, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE}

        hline <-  function(y = 0, color = "black") {
            list(
                type = "line", 
                x0 = 0, 
                x1 = 1, 
                xref = "paper",
                y0 = y, 
                y1 = y, 
                line = list(color = color)
            )
        }

            plot_ly(df2,x=~date) %>%
                add_lines(y=~rt,color=I("red")) %>%
                add_ribbons(ymin=~lower,ymax=~upper,color=I("grey"),
                            opacity=50) %>%
                layout(shapes = list(hline(1))) %>%
                layout(title="Taxa de Transmissão de COVID-19 em Belém-PA",xaxis=list(title="Date"),
                       yaxis=list(title="R(t)"),
                       showlegend = FALSE)
```
